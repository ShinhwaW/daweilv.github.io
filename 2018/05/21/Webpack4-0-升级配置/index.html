<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Webpack4.0 升级配置 · David 的个人博客 ๛ก(ｰ̀ωｰ́ก)</title><meta name="description" content="Webpack4.0 升级配置 - David"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://dawei.lv/atom.xml" title="David 的个人博客 ๛ก(ｰ̀ωｰ́ก)"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/daweilv" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Webpack4.0 升级配置</h1><div class="post-info">May 21, 2018</div><div class="post-content"><blockquote>
<p>本文基于 webpack 4.8.1</p>
</blockquote>
<h2 id="吐槽"><a href="#吐槽" class="headerlink" title="吐槽"></a>吐槽</h2><p>webpack 彪版本号的速度真是飞快，4.0 发布没多久上去看的时候才 4.1.*，现在已经刷到 4.8.1 了，给人一种“我版本号很高了，可以安心升级了”的感觉，然而坑依然很多…尤其是 API 文档，到处可见 3.0 的陈旧信息。<a href="https://webpack.js.org/guides/code-splitting/" target="_blank" rel="noopener">Code Splitting</a> 章节点进去依然在讲 CommonsChunkPlugin ，<a href="https://webpack.js.org/plugins/commons-chunk-plugin/" target="_blank" rel="noopener">CommonsChunkPlugin</a> 点进去提示去看 <a href="https://webpack.js.org/plugins/split-chunks-plugin/" target="_blank" rel="noopener">SplitChunksPlugin</a>，看文档的时候经常会迷失自我，心累…好了，吐槽完毕，下面是正文。需要直接复制粘贴的同学直接拉到<a href="#Demo">最后</a>~</p>
<a id="more"></a>
<h2 id="4-0-与-3-0-的区别"><a href="#4-0-与-3-0-的区别" class="headerlink" title="4.0 与 3.0 的区别"></a>4.0 与 3.0 的区别</h2><h4 id="mode"><a href="#mode" class="headerlink" title="mode"></a>mode</h4><p>webpack4.0 新增了 <code>mode</code> 的概念, <code>mode</code> 可以为 <code>development</code>、<code>production</code> 和 <code>none</code>。</p>
<p><code>development</code> 帮我们设置了 <code>process.env.NODE_ENV=development</code>，并添加了 <code>NamedModulesPlugin</code> 插件。<code>process.env.NODE_ENV=development</code> 可以用来显示一些在开发模式下才显示的 debug 信息，请注意这个 <code>NODE_ENV</code> 不能在 <code>webpack.config.js</code> 中使用，只能在你的源文件中使用。想要在 <code>webpack.config.js</code> 中也生效，需要在 package.json 的 script 脚本前添加 <code>NODE_ENV=development</code>，如 <code>NODE_ENV=development webpack --config webpack.dev.js</code>。<code>NamedModulesPlugin</code> 是在开启 HMR 的时候使用的插件。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// webpack.development.config.js</span><br><span class="line">module.exports = &#123;</span><br><span class="line"><span class="addition">+ mode: 'development'</span></span><br><span class="line"><span class="deletion">- plugins: [</span></span><br><span class="line"><span class="deletion">-   new webpack.NamedModulesPlugin(),</span></span><br><span class="line"><span class="deletion">-   new webpack.DefinePlugin(&#123; "process.env.NODE_ENV": JSON.stringify("development") &#125;),</span></span><br><span class="line"><span class="deletion">- ]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>production</code> 帮我们设置了 <code>process.env.NODE_ENV=production</code>，并添加了 <code>UglifyJsPlugin</code>、<code>ModuleConcatenationPlugin</code>、<code>NoEmitOnErrorsPlugin</code> 等插件，在设置了 <code>sideEffects=false</code> 之后可以实现未引用代码删除的功能。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// webpack.production.config.js</span><br><span class="line">module.exports = &#123;</span><br><span class="line"><span class="addition">+  mode: 'production',</span></span><br><span class="line"><span class="deletion">-  plugins: [</span></span><br><span class="line"><span class="deletion">-    new UglifyJsPlugin(/* ... */),</span></span><br><span class="line"><span class="deletion">-    new webpack.DefinePlugin(&#123; "process.env.NODE_ENV": JSON.stringify("production") &#125;),</span></span><br><span class="line"><span class="deletion">-    new webpack.optimize.ModuleConcatenationPlugin(),</span></span><br><span class="line"><span class="deletion">-    new webpack.NoEmitOnErrorsPlugin()</span></span><br><span class="line"><span class="deletion">-  ]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="optimization"><a href="#optimization" class="headerlink" title="optimization"></a>optimization</h4><p>另一个区别在于引入了 <code>optimization</code> 的概念，<code>optimization.minimizer</code> 和 <code>optimization.splitChunks</code> 是需要我们关注的两个配置。</p>
<p><code>optimization.minimizer</code> 用于指定 webpack 使用哪个代码压缩插件，默认为 <code>new webpack.optimize.UglifyJsPlugin</code>，推荐更换为 <code>UglifyJSPlugin</code>。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="addition">+const UglifyJSPlugin = require('uglifyjs-webpack-plugin');</span></span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">  //...</span><br><span class="line">  optimization: &#123;</span><br><span class="line">    minimizer: [</span><br><span class="line"><span class="deletion">-     new webpack.optimize.UglifyJsPlugin(&#123;&#125;)</span></span><br><span class="line"><span class="addition">+     new UglifyJSPlugin(&#123;&#125;)</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>optimization.splitChunks</code> 替代了 3.0 的 CommonsChunkPlugin，实现公共代码抽取。具体 API 参见<a href="https://webpack.js.org/plugins/split-chunks-plugin/" target="_blank" rel="noopener">SplitChunksPlugin</a>。划几个重点，webpack 生成已经给大部分用户提供了默认的设置，<code>mode=production</code> 就已经带了这个优化，BUT!! 默认开启的代码分割只对异步加载的代码有效，也就是如果你是多个入口的配置，那么你的 react、react-dom、react-router 等公共库以及你的 common 代码都会被重复打包进多个入口里。emmmmm，这叫什么开箱即用嘛，还是我们自己动手吧。</p>
<p>首先，<code>optimization.splitChunks.chunks</code> 设置为 <code>all</code>，使得 <code>async</code> 异步加载的代码和 <code>initial</code> 初始化的代码都会被抽取。<code>optimization.splitChunks.cacheGroups</code> 添加 <code>commons</code> 和 <code>vendors</code> （如下）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  optimization: &#123;</span><br><span class="line">    splitChunks: &#123;</span><br><span class="line">      chunks: <span class="string">"all"</span>,</span><br><span class="line">      cacheGroups: &#123;</span><br><span class="line">        commons: &#123;</span><br><span class="line">          name: <span class="string">"commons"</span>,</span><br><span class="line">          test: <span class="regexp">/src[\/]/</span>,</span><br><span class="line">          chunks: <span class="string">"initial"</span>,</span><br><span class="line">          priority: <span class="number">2</span>,</span><br><span class="line">          minChunks: <span class="number">2</span></span><br><span class="line">        &#125;,</span><br><span class="line">        vendors: &#123;</span><br><span class="line">          name: <span class="string">"vendors"</span>,</span><br><span class="line">          test: <span class="regexp">/node_modules/</span>,</span><br><span class="line">          chunks: <span class="string">"initial"</span>,</span><br><span class="line">          priority: <span class="number">10</span>,</span><br><span class="line">          minChunks: <span class="number">2</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里的 <code>name</code> 指定你要抽取出来的 js 的文件名，<code>test</code> 字段用来筛选你要匹配的代码，<code>minChunks:2</code> 表示代码被引用 2 次及以上就会被抽取出来，<code>commons</code> 实现抽取你的 <code>src</code> 文件夹下的公共代码，<code>vendors</code> 则用于抽取 node_modules 下的公共库。下面我们需要把我们抽取出来的 <code>commons.js</code> 和 <code>vendors.js</code> 添加到 HtmlWebpackPlugin ，以实现打包出来的 html 文件引用 <code>commons.js</code> 和 <code>vendors.js</code>。</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">new HtmlWebpackPlugin(&#123;</span><br><span class="line">    //...</span><br><span class="line"><span class="deletion">-   chunks: 'index',</span></span><br><span class="line"><span class="addition">+   chunks: ['vendors', 'commons', 'index'],</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>到笔者发布文章为止，HtmlWebpackPlugin 还不支持添加动态名称的 cacheGroups，无法将未明确指定 name 的 vendors~chunk-a~chunk-b.js 之类的 js 打包进代码中，不过可以看到<a href="https://github.com/jantimon/html-webpack-plugin/pull/945" target="_blank" rel="noopener">相关的代码</a>已经快要出来了。之后就可以实现更精细的代码分割打包了。</p>
</blockquote>
<h4 id="plugins"><a href="#plugins" class="headerlink" title="plugins"></a>plugins</h4><p>使用 <a href="https://github.com/webpack-contrib/mini-css-extract-plugin" target="_blank" rel="noopener">mini-css-extract-plugin</a> 替代 <code>extract-text-webpack-plugin</code>抽取 css 到单独文件中，使用 <a href="https://github.com/NMFR/optimize-css-assets-webpack-plugin" target="_blank" rel="noopener">optimize-css-assets-webpack-plugin</a> 对 css 进行压缩处理。</p>
<p><code>optimize-css-assets-webpack-plugin</code> 在使用的时候强烈推荐设置 <code>isSafe = true</code>，避免 z-index 被修改的<a href="https://github.com/NMFR/optimize-css-assets-webpack-plugin/issues/28" target="_blank" rel="noopener">问题</a>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> OptimizeCSSAssetsPlugin(&#123;</span><br><span class="line">  cssProcessorOptions: &#123;</span><br><span class="line">    isSafe: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p><a href="https://github.com/daweilv/webpack4-demo" target="_blank" rel="noopener">webpack4-demo</a> 是笔者整理的 webpack4.0 demo，详细的 webpack 配置可以在这里找到。</p>
<ol>
<li>支持开发/生产模式</li>
<li>支持开发模式下 HMR</li>
<li>支持代码分割、代码混淆压缩</li>
<li>支持未引用代码删除</li>
<li>支持 less、autoprefixer</li>
<li>支持单/多入口</li>
<li>支持查看打包各个模块占用大小</li>
</ol>
</div></article></div></main><footer><div class="paginator"><a href="/2018/05/30/阿里云RDS数据恢复方法/" class="prev">PREV</a><a href="/2017/05/04/在-Terminal-中打开-Sublime/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'lnyx';
var disqus_identifier = '2018/05/21/Webpack4-0-升级配置/';
var disqus_title = 'Webpack4.0 升级配置';
var disqus_url = 'http://dawei.lv/2018/05/21/Webpack4-0-升级配置/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//lnyx.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2018 <a href="https://github.com/daweilv" target="_blank" rel="nofollow">David</a>. Hosted by <a href="https://pages.coding.me" target="_blank" rel="nofollow">Coding Pages</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-119593463-1",'auto');ga('send','pageview');</script></body></html>