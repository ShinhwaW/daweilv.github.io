<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 使用 Webpack4.0 打包组件库并发布到 npm · David 的个人博客 ๛ก(ｰ̀ωｰ́ก)</title><meta name="description" content="使用 Webpack4.0 打包组件库并发布到 npm - David"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://dawei.lv/atom.xml" title="David 的个人博客 ๛ก(ｰ̀ωｰ́ก)"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/daweilv" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">使用 Webpack4.0 打包组件库并发布到 npm</h1><div class="post-info">Jun 8, 2018</div><div class="post-content"><p>本文将会介绍如何将自己写的组件库打包成第三方库，发布到 npm 上，同时支持在原生 js / React/ Vue 下使用。Webpack4 的升级指南可以参考下 <a href="https://dawei.lv/2018/05/21/Webpack4-0-%E5%8D%87%E7%BA%A7%E9%85%8D%E7%BD%AE/">Webpack4.0 升级配置</a>，本文不做赘述。</p>
<a id="more"></a>
<h2 id="使用-Webpack4-0-打包"><a href="#使用-Webpack4-0-打包" class="headerlink" title="使用 Webpack4.0 打包"></a>使用 Webpack4.0 打包</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/index.js</span></span><br><span class="line">exports <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">Tree</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Hello Tree'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>假设我们有上面的 index.js 文件，我们想要把打它打包成一个 tree.js 和一个 tree.min.js 包，并且我希望我既可以通过 <code>&lt;script src=&quot;../dist/tree.js&quot;&gt;&lt;/script&gt;</code> 直接 <code>new Tree()</code> ，又可以通过 <code>import Tree from &#39;tree&#39;</code> 或 <code>let Tree = require(&#39;tree&#39;)</code> 引入，怎么做呢？这就要使用 Webpack 来处理了。</p>
<p>Webpack 不仅可以打包 React / Vue 相关的项目工程，也可以单独打包 js 组件。先来看下入口与出口的配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  mode: <span class="string">"none"</span>,</span><br><span class="line">  entry: &#123;</span><br><span class="line">    tree: <span class="string">"./src/index.js"</span>,</span><br><span class="line">    <span class="string">"tree.min"</span>: <span class="string">"./src/index.js"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  output: &#123;</span><br><span class="line">    filename: <span class="string">"[name].js"</span>,</span><br><span class="line">    libraryExport: <span class="string">"default"</span>,</span><br><span class="line">    library: <span class="string">"Tree"</span>,</span><br><span class="line">    libraryTarget: <span class="string">"umd"</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="mode"><a href="#mode" class="headerlink" title="mode"></a>mode</h4><p>Webpack4.0 会在默认情况下开启 <code>mode=production</code>，这会无差别的压缩我们的 <code>tree.js</code> 和 <code>tree.min.js</code>，这不是我们想要的，禁用它。</p>
<h4 id="entry"><a href="#entry" class="headerlink" title="entry"></a>entry</h4><p><code>entry</code> 里面我们配置两个入口 <code>tree</code>、<code>&quot;tree.min&quot;</code>，让 webpack 可以打包出两个文件，我们可以针对两个入口做不同的处理。</p>
<h4 id="output"><a href="#output" class="headerlink" title="output"></a>output</h4><p><code>output</code> 的 <code>filename</code> 表示打包出来文件名叫什么。<code>libraryExport=default</code> 表示打包出来的组件直接对外暴露 <code>default</code> 属性，否则我们调用的时候需要 <code>new Tree.default()</code>，这不是我们希望的调用方式。<code>library=Tree</code> 表示对外暴露的组件叫什么，如果这个地方修改成了 <code>library=Bar</code>，那我们调用的时候就是 <code>new Bar()</code>。<code>libraryTarget=umd</code> 表示采用 UMD (Universal Module Definition) 的方式打包 js，同时支持在 CommonJS、AMD 和全局变量使用。</p>
<h4 id="optimization"><a href="#optimization" class="headerlink" title="optimization"></a>optimization</h4><p>怎么对 <code>tree.min.js</code> 压缩，但不对 <code>tree.js</code> 压缩呢？请看下面的配置部分：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">  optimization: &#123;</span><br><span class="line">        minimize: <span class="literal">true</span>,</span><br><span class="line">        minimizer: [</span><br><span class="line">            <span class="keyword">new</span> UglifyJSPlugin(&#123;</span><br><span class="line">                include: <span class="regexp">/\.min\.js$/</span>,</span><br><span class="line">            &#125;),</span><br><span class="line">        ],</span><br><span class="line">    &#125;,</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>通过 <code>include</code> 设置只压缩 <code>min.js</code> 结尾的文件，是不是很简单。这样我们就得到了 <code>dist/tree.min.js</code>、<code>dist/tree.js</code> 两个文件。下面我们开始发布代码到 npm。</p>
<h2 id="发布组件库到-npm-上"><a href="#发布组件库到-npm-上" class="headerlink" title="发布组件库到 npm 上"></a>发布组件库到 npm 上</h2><h4 id="发布之前"><a href="#发布之前" class="headerlink" title="发布之前"></a>发布之前</h4><p>发布之前，还有件事需要做，在项目根目录新建 <code>index.js</code>，添加内容</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">"production"</span>) &#123;</span><br><span class="line">  <span class="built_in">module</span>.exports = <span class="built_in">require</span>(<span class="string">"./dist/tree.min.js"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="built_in">module</span>.exports = <span class="built_in">require</span>(<span class="string">"./dist/tree.js"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改 <code>package.json</code> 的 <code>main</code> 为 <code>index.js</code>，指定我们通过 import / require 的时候入口文件位置。</p>
<h4 id="注册-npm"><a href="#注册-npm" class="headerlink" title="注册 npm"></a>注册 npm</h4><p>想要发布代码到 npm 上，需要先注册一个账号，你可以直接打开<a href="https://www.npmjs.com/signup" target="_blank" rel="noopener">官网注册</a>，这里我们选择更 cooooool 的方式注册。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm adduser</span><br></pre></td></tr></table></figure>
<p>依次输入 Username、Password、Email 完成注册。</p>
<h4 id="登录-npm"><a href="#登录-npm" class="headerlink" title="登录 npm"></a>登录 npm</h4><p>注册好账号之后需要在 Terminal 上登录 npm，在 Terminal 中直接注册的同学就不需用登录了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm login</span><br></pre></td></tr></table></figure>
<p>输入 Username、Password、Email 完成登录。</p>
<h4 id="发布到-npm"><a href="#发布到-npm" class="headerlink" title="发布到 npm"></a>发布到 npm</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm publish</span><br></pre></td></tr></table></figure>
<p>发布的包名就是你的 <code>package.json</code> 的 <code>name</code> 和 <code>version</code>。有冲突的话需要换一个哦。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>本文其实是笔者近期在开源的一个树形选择控件 <a href="https://github.com/daweilv/treejs" target="_blank" rel="noopener">@widgetjs/tree</a> 摸索出来的打包经验总结。为了简化配置，突出重点，省略了一些生产环境需要添加的较为繁琐的细节，正式的生产模式配置可以在 <a href="https://github.com/daweilv/treejs" target="_blank" rel="noopener">github</a> 上找到，也欢迎使用，多多提出意见。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/06/21/npm-版本号主要注意的规则/" class="prev">PREV</a><a href="/2018/05/30/阿里云RDS数据恢复方法/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'lnyx';
var disqus_identifier = '2018/06/08/webpack-打包组件库并发布到-npm/';
var disqus_title = '使用 Webpack4.0 打包组件库并发布到 npm';
var disqus_url = 'http://dawei.lv/2018/06/08/webpack-打包组件库并发布到-npm/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//lnyx.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2018 <a href="http://dawei.lv">David</a>. Hosted by <a href="https://pages.coding.me" style="font-weight: bold">{Coding Pages}</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-119593463-1",'auto');ga('send','pageview');</script></body></html>